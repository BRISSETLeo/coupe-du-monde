services:
  # Base de données MySQL pour les users
  mysql-users:
    image: mysql:8.0
    container_name: mysql-users
    environment:
      - MYSQL_ROOT_PASSWORD=rootpassword
      - MYSQL_DATABASE=users_db
      - MYSQL_USER=userservice
      - MYSQL_PASSWORD=userpassword
    volumes:
      - mysql_users_data:/var/lib/mysql
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "userservice", "-puserpassword"]
      interval: 10s
      timeout: 5s
      retries: 5

  # RabbitMQ - pas de ports exposés publiquement
  rabbitmq:
    build:
      context: ./services/rabbitmq
      dockerfile: Dockerfile
    container_name: rabbitmq
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Service Auth
  auth-service:
    build:
      context: ./services/auth
      dockerfile: Dockerfile
    container_name: auth-service
    environment:
      - DB_HOST=mysql-users
      - DB_USER=userservice
      - DB_PASSWORD=userpassword
      - DB_NAME=users_db
      - JWT_SECRET=your-secret-key-change-in-production
      - NODE_ENV=development
    depends_on:
      mysql-users:
        condition: service_healthy
    networks:
      - app-network

  # Service Users
  users-service:
    build:
      context: ./services/users
      dockerfile: Dockerfile
    container_name: users-service
    environment:
      - DB_HOST=mysql-users
      - DB_USER=userservice
      - DB_PASSWORD=userpassword
      - DB_NAME=users_db
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672
      - JWT_SECRET=your-secret-key-change-in-production
      - NODE_ENV=development
    depends_on:
      mysql-users:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - app-network

  payments-service:
    build:
      context: ./services/payments
      dockerfile: Dockerfile
    container_name: payments-service
    env_file:
      - ./services/payments/.env
    environment:
      - NODE_ENV=development
    networks:
      - app-network

  # Base de données MySQL pour les matchs
  mysql-matchs:
    image: mysql:8.0
    container_name: mysql-matchs
    restart: always
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_DATABASE=matchs_db
      - MYSQL_USER=matchs_service_user
      - MYSQL_PASSWORD=supersecret
    volumes:
      - mysql_matchs_data:/var/lib/mysql
      - ./services/matchs/db/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - app-network

  # Service Matchs
  matchs-service:
    build:
      context: ./services/matchs/api
      dockerfile: Dockerfile
    container_name: matchs-service
    environment:
      - DB_HOST=mysql-matchs
      - DB_USER=matchs_service_user
      - DB_PASSWORD=supersecret
      - DB_NAME=matchs_db
      - AUTH_SERVICE_URL=http://auth-service:4000
      - JWT_SECRET=your-secret-key-change-in-production
      - NODE_ENV=development
    depends_on:
      mysql-matchs:
        condition: service_healthy
    networks:
      - app-network

  # API Gateway - seul service avec port exposé
  api-gateway:
    build:
      context: ./services/gateway
      dockerfile: Dockerfile
    container_name: api-gateway
    ports:
      - "3000:3000"
    environment:
      - AUTH_SERVICE_URL=http://auth-service:4000
      - USERS_SERVICE_URL=http://users-service:4001
      - PAYMENTS_SERVICE_URL=http://payments-service:4002
      - MATCHS_SERVICE_URL=http://matchs-service:3000
      - NODE_ENV=development
    depends_on:
      - auth-service
      - users-service
      - matchs-service
    networks:
      - app-network

  

volumes:
  rabbitmq_data:
  mysql_users_data:
  mysql_matchs_data:

networks:
  app-network:
    driver: bridge 